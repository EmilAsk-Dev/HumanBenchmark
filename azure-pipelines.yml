trigger:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

variables:
  buildConfiguration: "Release"
  apiProject: "apps/Api/Api.csproj"
  webRoot: "apps/web"
  dotnetSdkVersion: "10.0.100"
  apiOutDir: "$(Build.ArtifactStagingDirectory)/api_out"

steps:
# ============================
# Checkout repo
# ============================
- checkout: self

# ============================
# Debug repo structure
# ============================
- script: |
    echo "PWD:" && pwd
    echo "Repo root:" && ls -la
    echo "apps/:" && ls -la apps || true
    echo "Find csproj:" && find apps -maxdepth 5 -type f -name "*.csproj" -print || true
    echo "Find package.json:" && find apps -maxdepth 4 -type f -name package.json -print || true
    echo "global.json (if exists):"
    test -f global.json && cat global.json || echo "No global.json"
  displayName: "Debug: verify repo paths"

# ============================
# Install .NET SDK 10.x
# ============================
- task: UseDotNet@2
  displayName: "Install .NET SDK $(dotnetSdkVersion)"
  inputs:
    packageType: "sdk"
    version: "$(dotnetSdkVersion)"
    includePreviewVersions: true

- script: |
    dotnet --info
    dotnet --list-sdks
  displayName: "Debug: dotnet version"

# ============================
# Web Build (React/Vite)
# ============================
- task: NodeTool@0
  displayName: "Use Node.js 20"
  inputs:
    versionSpec: "20.x"

- script: |
    test -d "$(webRoot)" || (echo "Web folder not found: $(webRoot)"; echo "apps/ contents:"; ls -la apps; exit 1)
    cd "$(webRoot)"
    node -v
    npm -v
    npm ci
    npm run build
  displayName: "Build Web"

# ============================
# Run Frontend Tests
# ============================
- script: |
    cd "$(webRoot)"
    npm run test -- --run
  displayName: "Run Frontend Tests"

# ============================
# API Restore + Publish (self-contained linux-x64)
# ============================
- task: DotNetCoreCLI@2
  displayName: "Restore API (linux-x64)"
  inputs:
    command: "restore"
    projects: "$(apiProject)"
    arguments: "-r linux-x64"

# ============================
# Run API Tests
# ============================
- task: DotNetCoreCLI@2
  displayName: "Run API Tests"
  inputs:
    command: "test"
    projects: "apps/Api.Tests/Api.Tests.csproj"
    arguments: "--configuration $(buildConfiguration) --logger trx --results-directory $(Build.ArtifactStagingDirectory)/TestResults"

- task: PublishTestResults@2
  displayName: "Publish Test Results"
  inputs:
    testResultsFormat: "VSTest"
    testResultsFiles: "$(Build.ArtifactStagingDirectory)/TestResults/*.trx"
    failTaskOnFailedTests: true
  condition: succeededOrFailed()

# ============================
# API Restore + Publish (self-contained linux-x64)
# ============================
- task: DotNetCoreCLI@2
  displayName: "Publish API (self-contained linux-x64)"
  inputs:
    command: "publish"
    publishWebProjects: false
    projects: "$(apiProject)"
    arguments: >
      --configuration $(buildConfiguration)
      -r linux-x64
      --self-contained true
      --output "$(apiOutDir)"
    zipAfterPublish: false

# ============================
# Copy web build into the published API's wwwroot
# (handles whether publish output is apiOutDir or apiOutDir/Api)
# ============================
- script: |
    set -e

    echo "apiOutDir contents:"
    ls -la "$(apiOutDir)"

    # Determine where the actual publish output ended up
    PUBLISH_ROOT="$(apiOutDir)"
    if [ -d "$(apiOutDir)/Api" ]; then
      PUBLISH_ROOT="$(apiOutDir)/Api"
      echo "Detected nested publish folder: $PUBLISH_ROOT"
    else
      echo "Publish folder: $PUBLISH_ROOT"
    fi

    mkdir -p "$PUBLISH_ROOT/wwwroot"
    cp -R "$(webRoot)/dist/"* "$PUBLISH_ROOT/wwwroot/"

    echo "Publish root after copying web:"
    ls -la "$PUBLISH_ROOT"
    echo "wwwroot listing:"
    ls -la "$PUBLISH_ROOT/wwwroot" || true
  displayName: "Copy Web dist into API wwwroot"

# ============================
# Normalize deploy root (remove Api nesting if present)
# Result will ALWAYS be Build.ArtifactStagingDirectory/deploy_root
# ============================
- script: |
    set -e

    rm -rf "$(Build.ArtifactStagingDirectory)/deploy_root"
    mkdir -p "$(Build.ArtifactStagingDirectory)/deploy_root"

    if [ -d "$(apiOutDir)/Api" ]; then
      echo "Using $(apiOutDir)/Api as deploy root (flattening)"
      cp -R "$(apiOutDir)/Api/"* "$(Build.ArtifactStagingDirectory)/deploy_root/"
    else
      echo "Using $(apiOutDir) as deploy root"
      cp -R "$(apiOutDir)/"* "$(Build.ArtifactStagingDirectory)/deploy_root/"
    fi

    echo "deploy_root contents:"
    ls -la "$(Build.ArtifactStagingDirectory)/deploy_root"
  displayName: "Normalize publish output (no Api folder in zip)"

# ============================
# Zip ONLY the contents (no root folder) -> correct extraction into /home/site/wwwroot
# ============================
- task: ArchiveFiles@2
  displayName: "Zip deployment package"
  inputs:
    rootFolderOrFile: "$(Build.ArtifactStagingDirectory)/deploy_root"
    includeRootFolder: false
    archiveType: "zip"
    archiveFile: "$(Build.ArtifactStagingDirectory)/api.zip"
    replaceExistingArchive: true

- task: PublishPipelineArtifact@1
  displayName: "Publish deploy zip artifact"
  inputs:
    targetPath: "$(Build.ArtifactStagingDirectory)/api.zip"
    artifact: "api"
    publishLocation: "pipeline"

# (Optional) publish web artifact too for debugging
- task: PublishPipelineArtifact@1
  displayName: "Publish Web artifact"
  inputs:
    targetPath: "$(webRoot)/dist"
    artifact: "web"
    publishLocation: "pipeline"

# ============================
# Deploy ZIP to Azure App Service
# ============================
- task: DownloadPipelineArtifact@2
  displayName: "Download deploy zip"
  inputs:
    artifact: "api"
    path: "$(Pipeline.Workspace)/api"

- task: AzureWebApp@1
  displayName: "Deploy to Azure Web App (ZIP)"
  inputs:
    azureSubscription: "sc-humanbenchmark-prod"
    appName: "humanbenchmark-prod"
    package: "$(Pipeline.Workspace)/api/api.zip"
