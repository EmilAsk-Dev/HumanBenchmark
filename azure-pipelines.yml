trigger:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

variables:
  buildConfiguration: "Release"
  apiProject: "apps/Api/Api.csproj"
  webRoot: "apps/web"
  dotnetSdkVersion: "10.0.100"
  apiOutDir: "$(Build.ArtifactStagingDirectory)/api_out"

steps:
# ============================
# Checkout repo
# ============================
- checkout: self

# ============================
# Debug repo structure
# ============================
- script: |
    echo "PWD:" && pwd
    echo "Repo root:" && ls -la
    echo "apps/:" && ls -la apps || true
    echo "Find csproj:" && find apps -maxdepth 5 -type f -name "*.csproj" -print || true
    echo "Find package.json:" && find apps -maxdepth 4 -type f -name package.json -print || true
    echo "global.json (if exists):"
    test -f global.json && cat global.json || echo "No global.json"
  displayName: "Debug: verify repo paths"

# ============================
# Install .NET SDK 10.x
# ============================
- task: UseDotNet@2
  displayName: "Install .NET SDK $(dotnetSdkVersion)"
  inputs:
    packageType: "sdk"
    version: "$(dotnetSdkVersion)"
    includePreviewVersions: true

- script: |
    dotnet --info
    dotnet --list-sdks
  displayName: "Debug: dotnet version"

# ============================
# Web Build (React/Vite)
# ============================
- task: NodeTool@0
  displayName: "Use Node.js 20"
  inputs:
    versionSpec: "20.x"

- script: |
    test -d "$(webRoot)" || (echo "Web folder not found: $(webRoot)"; echo "apps/ contents:"; ls -la apps; exit 1)
    cd "$(webRoot)"
    node -v
    npm -v
    npm ci
    npm run build
  displayName: "Build Web"

# ============================
# API Restore/Build/Publish (self-contained linux-x64)
# ============================
- task: DotNetCoreCLI@2
  displayName: "Restore API (linux-x64)"
  inputs:
    command: "restore"
    projects: "$(apiProject)"
    arguments: "-r linux-x64"

- task: DotNetCoreCLI@2
  displayName: "Build API"
  inputs:
    command: "build"
    projects: "$(apiProject)"
    arguments: "--configuration $(buildConfiguration) --no-restore"

- task: DotNetCoreCLI@2
  displayName: "Publish API (self-contained linux-x64)"
  inputs:
    command: "publish"
    publishWebProjects: false
    projects: "$(apiProject)"
    arguments: >
      --configuration $(buildConfiguration)
      --no-build
      -r linux-x64
      --self-contained true
      --output "$(apiOutDir)"
    zipAfterPublish: false

# ============================
# Copy Web dist into API wwwroot (same-origin hosting)
# ============================
- script: |
    mkdir -p "$(apiOutDir)/wwwroot"
    cp -R "$(webRoot)/dist/"* "$(apiOutDir)/wwwroot/"
  displayName: "Copy Web dist into API wwwroot"

# ============================
# Zip ONLY the contents (no root folder) -> prevents /wwwroot/Api nesting
# ============================
- task: ArchiveFiles@2
  displayName: "Zip deployment package"
  inputs:
    rootFolderOrFile: "$(apiOutDir)"
    includeRootFolder: false
    archiveType: "zip"
    archiveFile: "$(Build.ArtifactStagingDirectory)/api.zip"
    replaceExistingArchive: true

- task: PublishPipelineArtifact@1
  displayName: "Publish API zip artifact"
  inputs:
    targetPath: "$(Build.ArtifactStagingDirectory)/api.zip"
    artifact: "api"
    publishLocation: "pipeline"

# (Optional) publish web artifact too for debugging/downloading
- task: PublishPipelineArtifact@1
  displayName: "Publish Web artifact"
  inputs:
    targetPath: "$(webRoot)/dist"
    artifact: "web"
    publishLocation: "pipeline"

# ============================
# Deploy API ZIP to Azure App Service
# ============================
- task: DownloadPipelineArtifact@2
  displayName: "Download API artifact"
  inputs:
    artifact: "api"
    path: "$(Pipeline.Workspace)/api"

- task: AzureWebApp@1
  displayName: "Deploy to Azure Web App (ZIP)"
  inputs:
    azureSubscription: "sc-humanbenchmark-prod"
    appName: "humanbenchmark-prod"
    package: "$(Pipeline.Workspace)/api/api.zip"
